name: 01) Deploy Wazuh Core (single lab)

on:
  workflow_dispatch:
    inputs:
      overlay:
        description: "Overlay to deploy (single or production)"
        required: true
        default: "single"
      wazuh_tag:
        description: "wazuh-kubernetes repo tag (e.g., v4.12.0)"
        required: true
        default: "v4.12.0"
      enable_port_forward:
        description: "Start port-forward to dashboard (true/false)"
        required: true
        default: "true"
      local_forward_port:
        description: "Local port for port-forward"
        required: true
        default: "8444"

jobs:
  core:
    runs-on: [self-hosted, linux, ronin, k8s, control-plane]
    timeout-minutes: 120

    env:
      NS: wazuh
      WAZUH_K8S_TAG: ${{ inputs.wazuh_tag }}
      OVERLAY_CHOICE: ${{ inputs.overlay }}
      LOCAL_FORWARD_PORT: ${{ inputs.local_forward_port }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install CLIs (no sudo)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/bin"
          echo "$HOME/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/bin:$PATH"
          if ! command -v kubectl >/dev/null 2>&1; then
            KVER="$(curl -sS https://dl.k8s.io/release/stable.txt)"
            curl -sSL "https://dl.k8s.io/release/${KVER}/bin/linux/amd64/kubectl" -o "$HOME/bin/kubectl"
            chmod +x "$HOME/bin/kubectl"
          fi
          if ! command -v yq >/dev/null 2>&1; then
            curl -sSL -o "$HOME/bin/yq" https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64
            chmod +x "$HOME/bin/yq"
          fi
          if ! command -v jq >/dev/null 2>&1; then
            curl -sSL -o "$HOME/bin/jq" https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64
            chmod +x "$HOME/bin/jq"
          fi

      - name: Ensure namespace
        shell: bash
        run: |
          kubectl create namespace "$NS" --dry-run=client -o yaml | kubectl apply -f -

      - name: Ensure vm.max_map_count via DaemonSet (required by OpenSearch)
        shell: bash
        run: |
          set -euo pipefail
          cat > /tmp/wazuh-sysctl-ds.yaml <<'EOF'
          apiVersion: apps/v1
          kind: DaemonSet
          metadata:
            name: wazuh-sysctl
            namespace: kube-system
            labels: { app: wazuh-sysctl }
          spec:
            selector: { matchLabels: { app: wazuh-sysctl } }
            template:
              metadata: { labels: { app: wazuh-sysctl } }
              spec:
                hostPID: true
                tolerations: [ {operator: Exists} ]
                containers:
                  - name: sysctl
                    image: busybox:1.36
                    securityContext: { privileged: true }
                    command: ["/bin/sh","-c"]
                    args:
                      - |
                        set -e
                        echo 262144 > /host-proc/sys/vm/max_map_count
                        mkdir -p /host-etc/sysctl.d
                        echo "vm.max_map_count=262144" > /host-etc/sysctl.d/99-wazuh.conf
                        # keep alive so the DS stays running
                        sleep 3600
                    volumeMounts:
                      - { name: host-proc, mountPath: /host-proc }
                      - { name: host-etc,  mountPath: /host-etc  }
                volumes:
                  - { name: host-proc, hostPath: { path: /proc, type: Directory } }
                  - { name: host-etc,  hostPath: { path: /etc,  type: Directory } }
          EOF
          kubectl apply -f /tmp/wazuh-sysctl-ds.yaml

      - name: Fetch official wazuh-kubernetes repo
        shell: bash
        run: |
          set -e
          rm -rf wazuh-kubernetes
          git clone --depth 1 --branch "$WAZUH_K8S_TAG" https://github.com/wazuh/wazuh-kubernetes.git

      # Create the cert files Kustomize expects (indexer cluster + dashboard)
      - name: Generate self-signed certs (indexer cluster + dashboard)
        shell: bash
        run: |
          set -euo pipefail
          CERTROOT="$GITHUB_WORKSPACE/wazuh-kubernetes/wazuh/certs"
          IC="$CERTROOT/indexer_cluster"
          DH="$CERTROOT/dashboard_http"
          mkdir -p "$IC" "$DH"

          cat > /tmp/wazuh-openssl.cnf <<'CONF'
          [req]
          default_bits=2048
          prompt=no
          default_md=sha256
          req_extensions = v3_req
          distinguished_name=req_dn
          [req_dn]
          CN=wazuh-local
          [v3_req]
          basicConstraints = CA:FALSE
          keyUsage = digitalSignature, keyEncipherment
          extendedKeyUsage = serverAuth, clientAuth
          subjectAltName = @alt_names
          [alt_names]
          DNS.1 = wazuh-indexer
          DNS.2 = wazuh-indexer.wazuh.svc
          DNS.3 = wazuh-dashboard
          DNS.4 = wazuh-dashboard.wazuh.svc
          DNS.5 = localhost
          IP.1  = 127.0.0.1
          CONF

          # Root CA
          openssl genrsa -out "$IC/root-ca-key.pem" 4096
          openssl req -x509 -new -key "$IC/root-ca-key.pem" -sha256 -days 3650 \
            -out "$IC/root-ca.pem" -subj "/CN=Wazuh Root CA"

          sign_ic () {
            local name="$1"
            openssl genrsa -out "$IC/${name}-key.pem" 2048
            openssl req -new -key "$IC/${name}-key.pem" -out "$IC/${name}.csr" -config /tmp/wazuh-openssl.cnf
            openssl x509 -req -in "$IC/${name}.csr" -CA "$IC/root-ca.pem" -CAkey "$IC/root-ca-key.pem" \
              -CAcreateserial -out "$IC/${name}.pem" -days 825 -sha256 \
              -extensions v3_req -extfile /tmp/wazuh-openssl.cnf
            rm -f "$IC/${name}.csr"
          }
          for n in admin node dashboard filebeat; do sign_ic "$n"; done

          # Dashboard HTTPS cert
          openssl genrsa -out "$DH/key.pem" 2048
          openssl req -new -key "$DH/key.pem" -out "$DH/dashboard.csr" -config /tmp/wazuh-openssl.cnf
          openssl x509 -req -in "$DH/dashboard.csr" -CA "$IC/root-ca.pem" -CAkey "$IC/root-ca-key.pem" \
            -CAcreateserial -out "$DH/cert.pem" -days 825 -sha256 \
            -extensions v3_req -extfile /tmp/wazuh-openssl.cnf
          rm -f "$DH/dashboard.csr"

      - name: Build overlay (drop StorageClass; 1 indexer & 1 worker)
        shell: bash
        run: |
          set -e
          kubectl kustomize "$GITHUB_WORKSPACE/wazuh-kubernetes/wazuh" > /tmp/wazuh-all.yaml
          # remove StorageClass so we don't override cluster defaults
          yq 'select(.kind != "StorageClass")' /tmp/wazuh-all.yaml > /tmp/wazuh-all.nosc.yaml
          mv /tmp/wazuh-all.nosc.yaml /tmp/wazuh-all.yaml

          # set demo-friendly replicas
          yq -i '
            (select(.kind=="StatefulSet" and .metadata.name=="wazuh-indexer").spec.replicas) = 1 |
            (select(.kind=="StatefulSet" and .metadata.name=="wazuh-manager-worker").spec.replicas) = 1
          ' /tmp/wazuh-all.yaml

          # ---- Resize PVCs safely in the manifests BEFORE apply ----
          # Increase indexer data PVC to 60Gi, manager PVCs to 10Gi each.
          # This catches any volumeClaimTemplates in those StatefulSets.
          yq -i '
            with(select(.kind=="StatefulSet" and .metadata.name=="wazuh-indexer").spec.volumeClaimTemplates[];
                 .[] |= (.spec.resources.requests.storage = "60Gi")) |
            with(select(.kind=="StatefulSet" and .metadata.name=="wazuh-manager-master").spec.volumeClaimTemplates[];
                 .[] |= (.spec.resources.requests.storage = "10Gi")) |
            with(select(.kind=="StatefulSet" and .metadata.name=="wazuh-manager-worker").spec.volumeClaimTemplates[];
                 .[] |= (.spec.resources.requests.storage = "10Gi"))
          ' /tmp/wazuh-all.yaml

          # ensure a clean dashboard deploy (wazuh sometimes provides both sts/deploy across versions)
          kubectl -n "$NS" delete deploy wazuh-dashboard --ignore-not-found=true || true

      - name: Apply non-StatefulSet resources
        shell: bash
        run: |
          set -e
          yq -o=y 'select(.kind != "StatefulSet")' /tmp/wazuh-all.yaml > /tmp/non-sts.yaml
          if [ -s /tmp/non-sts.yaml ]; then kubectl -n "$NS" apply -f /tmp/non-sts.yaml; fi

      - name: Apply StatefulSets (with resized PVCs)
        shell: bash
        run: |
          set -e
          yq -o=y 'select(.kind == "StatefulSet")' /tmp/wazuh-all.yaml > /tmp/sts.yaml
          kubectl -n "$NS" apply -f /tmp/sts.yaml

      - name: Enforce images, heap & requests (no limits) + restarts
        shell: bash
        run: |
          set -euo pipefail
          TAG_NO_V="${WAZUH_K8S_TAG#v}"

          # Ensure indexer image matches selected tag
          kubectl -n "$NS" set image statefulset/wazuh-indexer wazuh-indexer="wazuh/wazuh-indexer:${TAG_NO_V}"

          # Heap that can grow: 1g -> 8g
          kubectl -n "$NS" set env statefulset/wazuh-indexer OPENSEARCH_JAVA_OPTS="-Xms1g -Xmx8g -Dlog4j2.formatMsgNoLookups=true"

          # Requests only (no limits): reserve min, allow growth
          kubectl -n "$NS" set resources statefulset/wazuh-indexer \
            --containers=wazuh-indexer --requests=cpu=500m,memory=4Gi --limits=
          kubectl -n "$NS" patch statefulset/wazuh-indexer --type=json -p='[
            {"op":"remove","path":"/spec/template/spec/containers/0/resources/limits"}
          ]' || true

          for s in wazuh-manager-master wazuh-manager-worker; do
            kubectl -n "$NS" set resources statefulset/$s \
              --containers=wazuh-manager --requests=cpu=300m,memory=2Gi --limits=
            kubectl -n "$NS" patch statefulset/$s --type=json -p='[
              {"op":"remove","path":"/spec/template/spec/containers/0/resources/limits"}
            ]' || true
          done

          kubectl -n "$NS" set resources deploy/wazuh-dashboard \
            --containers=wazuh-dashboard --requests=cpu=200m,memory=1Gi --limits=
          kubectl -n "$NS" patch deploy/wazuh-dashboard --type=json -p='[
            {"op":"remove","path":"/spec/template/spec/containers/0/resources/limits"}
          ]' || true

          # pick up env/resource changes
          kubectl -n "$NS" rollout restart statefulset/wazuh-indexer
          kubectl -n "$NS" rollout restart statefulset/wazuh-manager-master
          kubectl -n "$NS" rollout restart statefulset/wazuh-manager-worker
          kubectl -n "$NS" rollout restart deployment/wazuh-dashboard

      - name: Wait for core to be Ready
        shell: bash
        run: |
          set -e
          for sel in "app=wazuh-indexer" "app=wazuh-manager" "app=wazuh-dashboard"; do
            echo "Waiting for: $sel"
            kubectl -n "$NS" wait --for=condition=Ready pod -l "$sel" --timeout=1200s || true
            kubectl -n "$NS" get pods -l "$sel" -o wide
          done
          echo "PVCs:"
          kubectl -n "$NS" get pvc

      - name: Discover Dashboard port
        id: dash
        shell: bash
        run: |
          set -euo pipefail
          PORT="$(kubectl -n "$NS" get svc -l app=wazuh-dashboard -o jsonpath='{.items[0].spec.ports[0].port}' 2>/dev/null || true)"
          if [ -z "${PORT:-}" ]; then
            PORT="$(kubectl -n "$NS" get deploy wazuh-dashboard -o jsonpath='{.spec.template.spec.containers[0].ports[0].containerPort}' 2>/dev/null || true)"
          fi
          test -n "${PORT:-}" || { echo "::error::Could not determine dashboard port"; exit 1; }
          echo "dash_port=${PORT}" >> "$GITHUB_OUTPUT"

      - name: Start Dashboard port-forward (optional)
        if: ${{ inputs.enable_port_forward == 'true' }}
        shell: bash
        env:
          PF_BIND: 127.0.0.1
          PF_PORT: ${{ inputs.local_forward_port }}
        run: |
          set -euo pipefail
          TARGET_PORT="${{ steps.dash.outputs.dash_port }}"
          (pkill -f "port-forward .*:${PF_PORT}:" && sleep 1) || true
          nohup kubectl -n "${NS}" port-forward --address "${PF_BIND}" deploy/wazuh-dashboard "${PF_PORT}:${TARGET_PORT}" > portforward.log 2>&1 &
          echo "::notice title=Browse Now::Open http://localhost:${PF_PORT}"

      - name: Final status
        shell: bash
        run: |
          kubectl -n "$NS" get pods -o wide
          kubectl -n "$NS" get pvc
