name: Deploy Wazuh Agent (manual)

on:
  workflow_dispatch:

concurrency:
  group: deploy-wazuh-agent
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    runs-on:
      - self-hosted
      - linux
      - ronin
      - k8s
      - control-plane

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kubectl
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL -o kubectl "https://dl.k8s.io/release/$(curl -fsSL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/kubectl
          kubectl version --client --output=yaml

      - name: Write kubeconfig from secret
        shell: bash
        env:
          # Make sure this exact repo secret exists
          KUBE_CONFIG_B64: ${{ secrets.KUBE_CONFIG_B64 }}
        run: |
          set -euo pipefail
          test -n "${KUBE_CONFIG_B64:-}"
          mkdir -p "$HOME/.kube"
          echo "$KUBE_CONFIG_B64" | base64 -d > "$HOME/.kube/config"
          chmod 600 "$HOME/.kube/config"
          echo "Current context: $(kubectl config current-context)"
          echo "Cluster nodes:"; kubectl get nodes -o wide

      - name: Apply Wazuh Agent manifest
        shell: bash
        run: |
          set -euo pipefail
          kubectl apply -f manifests/wazuh-agent.yaml
          kubectl -n wazuh rollout status ds/wazuh-agent --timeout=300s || true
          kubectl -n wazuh get ds/wazuh-agent
          kubectl -n wazuh get pods -l app=wazuh-agent -o wide || true
