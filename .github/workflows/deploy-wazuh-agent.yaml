name: Deploy Wazuh Agent (Passwordless)

on:
  workflow_dispatch:
  push:
    paths:
      - "k8s/wazuh-agent-passwordless.yaml"
      - ".github/workflows/deploy-wazuh-agent.yaml"

permissions:
  contents: read

concurrency:
  group: wazuh-agent-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    # Your Ronin self-hosted runner labels; adjust if yours differ
    runs-on: [self-hosted, linux, ronin, k8s, control-plane]
    timeout-minutes: 20
    env:
      NS: wazuh
      MANIFEST: k8s/wazuh-agent-passwordless.yaml
      # If your runner has admin.conf, weâ€™ll use it; otherwise we assume ~/.kube/config is already set up
      KADMIN: /etc/kubernetes/admin.conf

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure kubectl context (prefer admin.conf if present)
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "$KADMIN" ]; then
            export KUBECONFIG="$KADMIN"
            # Put it in GITHUB_ENV so later steps inherit it
            echo "KUBECONFIG=$KADMIN" >> "$GITHUB_ENV"
            echo "Using kubeconfig: $KADMIN"
          else
            echo "Using default kubeconfig (likely ~/.kube/config)"
          fi
          kubectl version --client
          kubectl version || true

      - name: Create namespace (idempotent)
        shell: bash
        run: |
          kubectl get ns "$NS" >/dev/null 2>&1 || kubectl create ns "$NS"

      - name: Apply passwordless Wazuh Agent DaemonSet
        shell: bash
        run: |
          kubectl apply -f "$MANIFEST"

      - name: Wait for rollout
        shell: bash
        run: |
          set -e
          kubectl -n "$NS" rollout status ds/wazuh-agent --timeout=600s

      - name: Quick health check
        shell: bash
        run: |
          set -e
          echo "Pods:"
          kubectl -n "$NS" get pods -l app=wazuh-agent -o wide
          POD="$(kubectl -n "$NS" get pod -l app=wazuh-agent -o jsonpath='{.items[0].metadata.name}')"
          echo "One pod log (first 120 lines): $POD"
          kubectl -n "$NS" logs --tail=120 "$POD" || true
