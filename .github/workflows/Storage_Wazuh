
name: 01) Wazuh — Storage + Core (single-node friendly)

on:
  workflow_dispatch:
    inputs:
      overlay:
        description: "Overlay to deploy (single or production) [ignored if repo uses single root kustomization]"
        required: true
        default: "single"
      wazuh_tag:
        description: "wazuh-kubernetes repo tag (e.g., v4.12.0)"
        required: true
        default: "v4.12.0"
      enable_port_forward:
        description: "Start port-forward to dashboard (true/false)"
        required: true
        default: "true"
      local_forward_port:
        description: "Local port for port-forward"
        required: true
        default: "8444"

jobs:
  storage_core:
    runs-on: [self-hosted, linux, ronin, k8s, control-plane]
    timeout-minutes: 120

    env:
      NS: wazuh
      KUBECONFIG_PATH: ${{ github.workspace }}/kubeconfig.yaml
      KUBECONFIG:      ${{ github.workspace }}/kubeconfig.yaml
      WAZUH_K8S_TAG:   ${{ inputs.wazuh_tag }}
      OVERLAY_CHOICE:  ${{ inputs.overlay }}
      RAW_KCFG:        ${{ secrets.KUBECONFIG }}
      KCFG_B64_A:      ${{ secrets.KUBE_CONFIG_B64 }}
      KCFG_B64_B:      ${{ secrets.KUBECONFIG_B64 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install CLIs (no sudo) and persist PATH
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/bin"
          echo "$HOME/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/bin:$PATH"
          if ! command -v kubectl >/dev/null 2>&1; then
            KVER="$(curl -sS https://dl.k8s.io/release/stable.txt)"
            curl -sSL "https://dl.k8s.io/release/${KVER}/bin/linux/amd64/kubectl" -o "$HOME/bin/kubectl"
            chmod +x "$HOME/bin/kubectl"
          fi
          if ! command -v yq >/dev/null 2>&1; then
            curl -sSL -o "$HOME/bin/yq" https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64
            chmod +x "$HOME/bin/yq"
          fi
          if ! command -v jq >/dev/null 2>&1; then
            curl -sSL -o "$HOME/bin/jq" https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64
            chmod +x "$HOME/bin/jq"
          fi

      - name: Write kubeconfig
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${RAW_KCFG:-}" ]; then
            printf '%s' "$RAW_KCFG" > "$KUBECONFIG_PATH"
          elif [ -n "${KCFG_B64_A:-}" ]; then
            printf '%s' "$KCFG_B64_A" | base64 -d > "$KUBECONFIG_PATH"
          elif [ -n "${KCFG_B64_B:-}" ]; then
            printf '%s' "$KCFG_B64_B" | base64 -d > "$KUBECONFIG_PATH"
          else
            echo "::error::No kubeconfig secret found"; exit 1
          fi
          chmod 600 "$KUBECONFIG_PATH"
          kubectl cluster-info
          kubectl get nodes -o wide

      - name: Ensure namespace exists
        run: kubectl create namespace "$NS" --dry-run=client -o yaml | kubectl apply -f -

      - name: Prepare StorageClass alias 'wazuh-storage'
        shell: bash
        run: |
          set -euo pipefail
          TARGET_SC="$(kubectl get sc -o json | yq -r '.items[] | select(.metadata.annotations."storageclass.kubernetes.io/is-default-class"=="true") | .metadata.name' | head -n1 || true)"
          if [ -z "${TARGET_SC:-}" ]; then
            if kubectl get sc local-path >/dev/null 2>&1; then
              TARGET_SC="local-path"
            else
              echo "::error::No default StorageClass found and no 'local-path' provisioner installed"; exit 1
            fi
          fi
          PROV="$(kubectl get sc "$TARGET_SC" -o jsonpath='{.provisioner}')"

          # If wazuh-storage exists with wrong fields → delete and recreate
          if kubectl get sc wazuh-storage >/dev/null 2>&1; then
            CUR_PROV="$(kubectl get sc wazuh-storage -o jsonpath='{.provisioner}' || true)"
            CUR_VBM="$(kubectl get sc wazuh-storage -o jsonpath='{.volumeBindingMode}' || true)"
            if [ "$CUR_PROV" != "$PROV" ] || [ "$CUR_VBM" != "WaitForFirstConsumer" ]; then
              echo "Deleting existing wazuh-storage (wrong settings)"
              kubectl delete sc wazuh-storage
            fi
          fi

          if ! kubectl get sc wazuh-storage >/dev/null 2>&1; then
            cat <<EOF | kubectl apply -f -
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: wazuh-storage
provisioner: ${PROV}
reclaimPolicy: Delete
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true
EOF
          fi

          kubectl get sc -o wide

      - name: Fetch wazuh-kubernetes repo
        run: git clone --depth 1 --branch "$WAZUH_K8S_TAG" https://github.com/wazuh/wazuh-kubernetes.git

      - name: Generate self-signed certs
        shell: bash
        run: |
          set -e
          CERTROOT="wazuh-kubernetes/wazuh/certs"
          mkdir -p "$CERTROOT/indexer_cluster" "$CERTROOT/dashboard_http"
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout "$CERTROOT/indexer_cluster/root-ca-key.pem" -out "$CERTROOT/indexer_cluster/root-ca.pem" -subj "/CN=wazuh-root"
          for n in admin node dashboard filebeat; do
            openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout "$CERTROOT/indexer_cluster/$n-key.pem" -out "$CERTROOT/indexer_cluster/$n.pem" -subj "/CN=$n"
          done
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout "$CERTROOT/dashboard_http/key.pem" -out "$CERTROOT/dashboard_http/cert.pem" -subj "/CN=dashboard"

      - name: Build overlay (yaml)
        shell: bash
        run: |
          kubectl kustomize "wazuh-kubernetes/wazuh" > /tmp/wazuh-all.yaml
          yq -i 'del(.[] | select(.kind=="StorageClass"))' /tmp/wazuh-all.yaml
          yq -i '
            (.[] | select(.kind=="StatefulSet" and .metadata.name=="wazuh-indexer").spec.replicas) = 1 |
            (.[] | select(.kind=="StatefulSet" and .metadata.name=="wazuh-indexer").spec.volumeClaimTemplates[]?).spec.resources.requests.storage = "60Gi" |
            (.[] | select(.kind=="StatefulSet" and .metadata.name=="wazuh-manager-master").spec.volumeClaimTemplates[]?).spec.resources.requests.storage = "20Gi"
          ' /tmp/wazuh-all.yaml

      - name: Apply non-StatefulSet resources
        run: |
          yq -o=y e 'select(.kind != "StatefulSet")' /tmp/wazuh-all.yaml > /tmp/non-sts.yaml
          if [ -s /tmp/non-sts.yaml ]; then kubectl -n "$NS" apply -f /tmp/non-sts.yaml; fi

      - name: Apply StatefulSets
        run: |
          yq -o=y e 'select(.kind == "StatefulSet")' /tmp/wazuh-all.yaml > /tmp/sts.yaml
          kubectl -n "$NS" apply -f /tmp/sts.yaml

      - name: Wait for core
        run: |
          for sel in "app=wazuh-indexer" "app=wazuh-manager" "app=wazuh-dashboard"; do
            kubectl -n "$NS" wait --for=condition=Ready pod -l "$sel" --timeout=1200s || true
            kubectl -n "$NS" get pods -l "$sel" -o wide
          done
